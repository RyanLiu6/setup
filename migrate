#!/bin/bash
set -e

# Migration script for updating from old setup to new loader architecture
# This script:
# 1. Backs up existing ~/.zshrc
# 2. Runs the full setup
# 3. Cleans up ~/.zshrc to remove content now handled by tracked config

SETUP_DIR="${SETUP_DIR:-$HOME/dev/setup}"

echo "======================================"
echo "Setup Migration Tool"
echo "======================================"
echo ""

# Check if we're in the right directory
if [[ ! -f "$SETUP_DIR/setup" ]]; then
    echo "âŒ Could not find setup directory at $SETUP_DIR"
    echo "   Please set SETUP_DIR or run from ~/dev/setup"
    exit 1
fi

# Step 1: Backup existing ~/.zshrc if it exists
if [[ -f ~/.zshrc ]]; then
    BACKUP_FILE=~/.zshrc.backup.$(date +%Y%m%d_%H%M%S)
    echo "ðŸ“¦ Backing up ~/.zshrc to $BACKUP_FILE"
    cp ~/.zshrc "$BACKUP_FILE"
    echo ""
fi

# Step 2: Run the full setup
echo "ðŸ”§ Running full setup..."
echo ""
"$SETUP_DIR/setup"
echo ""

# Step 3: Clean up ~/.zshrc
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Cleaning up ~/.zshrc"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Create a temporary file for the cleaned content
tmp_file=$(mktemp)

# Patterns that are now handled by tracked config and should be removed
# These are lines/blocks that were in old ~/.zshrc but are now in shell/.zshrc or shell/.zsh/*
declare -a REMOVE_PATTERNS=(
    # Starship (now in shell/.zshrc)
    'eval "\$(starship init zsh)"'
    'export STARSHIP_CONFIG='

    # Direnv (now in shell/.zsh/base.zsh)
    'eval "\$(direnv hook zsh)"'

    # fnm/Node (now in shell/.zsh/base.zsh)
    'eval "\$(fnm env'
    'export PATH=.*fnm'

    # pnpm (now in shell/.zsh/base.zsh)
    'export PNPM_HOME='
    'export PATH=.*PNPM_HOME'

    # uv (now in shell/.zsh/base.zsh)
    'export PATH="\$HOME/.local/bin:\$PATH"'

    # Editor settings (now in shell/.zsh/base.zsh)
    'export EDITOR=vim'
    'export VISUAL=vim'

    # Locale settings (now in shell/.zsh/base.zsh)
    'export LC_ALL=en_US.UTF-8'
    'export LANG=en_US.UTF-8'
    'export LANGUAGE=en_US.UTF-8'

    # History settings (now in shell/.zsh/base.zsh)
    'HISTFILE=~/.zhistory'
    'HISTSIZE='
    'SAVEHIST='
    'setopt.*HISTORY'

    # Completion init (now in shell/.zsh/base.zsh)
    'autoload -Uz compinit && compinit'

    # Old source line pointing to setup (will be re-added by loader)
    'source.*/dev/setup/shell/\.zshrc'

    # LESS_TERMCAP settings (now in shell/.zsh/base.zsh)
    'export LESS_TERMCAP_'

    # DATA_DIRECTORY (now in shell/.zsh/base.zsh)
    'export DATA_DIRECTORY='
    'export OLLAMA_MODELS='
)

# Read ~/.zshrc and filter out lines matching remove patterns
# But preserve: loader header, tool-installed blocks, and personal customizations

in_preserved_block=false
block_markers=("gohan" "BENTO" "instacart")

while IFS= read -r line || [[ -n "$line" ]]; do
    # Check if we're entering a preserved block
    for marker in "${block_markers[@]}"; do
        if [[ "$line" =~ ">>>".*"$marker".*"<<<"  ]] || \
           [[ "$line" =~ "BEGIN".*"$marker" ]] || \
           [[ "$line" =~ "$marker".*"START" ]]; then
            in_preserved_block=true
            break
        fi
    done

    # Check if we're exiting a preserved block
    if $in_preserved_block; then
        for marker in "${block_markers[@]}"; do
            if [[ "$line" =~ "<<<".*"$marker".*">>>" ]] || \
               [[ "$line" =~ "END".*"$marker" ]] || \
               [[ "$line" =~ "$marker".*"END" ]]; then
                echo "$line" >> "$tmp_file"
                in_preserved_block=false
                continue 2
            fi
        done
        # Inside preserved block, keep the line
        echo "$line" >> "$tmp_file"
        continue
    fi

    # Check if line matches any remove pattern
    should_remove=false
    for pattern in "${REMOVE_PATTERNS[@]}"; do
        if [[ "$line" =~ $pattern ]]; then
            should_remove=true
            break
        fi
    done

    # Keep the line if it doesn't match remove patterns
    if ! $should_remove; then
        echo "$line" >> "$tmp_file"
    fi
done < ~/.zshrc

# Remove consecutive blank lines (more than 2)
awk 'NF {blank=0} !NF {blank++} blank<=2' "$tmp_file" > "${tmp_file}.clean"
mv "${tmp_file}.clean" "$tmp_file"

# Replace ~/.zshrc with cleaned version
mv "$tmp_file" ~/.zshrc

echo "âœ“ Cleaned up ~/.zshrc"
echo ""
echo "  The following types of content were removed (now in tracked config):"
echo "  - Starship initialization"
echo "  - Direnv hook"
echo "  - fnm/Node setup"
echo "  - pnpm PATH"
echo "  - uv PATH"
echo "  - Editor/locale/history settings"
echo "  - Completion initialization"
echo ""
echo "  The following were preserved:"
echo "  - Loader header (sources tracked config)"
echo "  - Tool-installed blocks (gohan, bento, instacart, etc.)"
echo "  - bashcompinit setup"
echo "  - Any unrecognized personal customizations"
echo ""

echo "======================================"
echo "âœ“ Migration complete!"
echo "======================================"
echo ""
echo "Your old ~/.zshrc was backed up to: $BACKUP_FILE"
echo ""
echo "Please review ~/.zshrc and remove any remaining duplicates."
echo "Then restart your terminal or run: source ~/.zshrc"
echo ""
