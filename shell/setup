#!/bin/bash
set -e

REPO_DIR="${REPO_DIR:-$(cd "$(dirname "$0")/.." && pwd)}"

# Source platform detection helpers
source "$REPO_DIR/lib/platform.sh"

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "Shell Configuration Setup"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

OS=$(detect_os)

# Ensure zsh is installed (especially important for Linux)
ensure_zsh

echo "üìù Setting up shell configuration..."
echo ""

# Symlink .zprofile
if [[ -f "$REPO_DIR/shell/.zprofile" ]]; then
    if [[ -L ~/.zprofile ]]; then
        echo "  ‚úì .zprofile already linked"
    elif [[ -f ~/.zprofile ]]; then
        echo "  ‚Üí Backing up existing .zprofile..."
        mv ~/.zprofile ~/.zprofile.backup
        ln -s "$REPO_DIR/shell/.zprofile" ~/.zprofile
        echo "  ‚úì .zprofile linked (backup saved)"
    else
        ln -s "$REPO_DIR/shell/.zprofile" ~/.zprofile
        echo "  ‚úì .zprofile linked"
    fi
fi

# Setup ~/.zshrc as a loader that sources our config
# This allows tools to add lines to ~/.zshrc without breaking our setup
if [[ ! -f ~/.zshrc ]]; then
    # No .zshrc exists, create from loader template with correct path
    sed "s|__REPO_DIR__|$REPO_DIR|g" "$REPO_DIR/shell/.zshrc.loader" > ~/.zshrc
    echo "  ‚úì Created ~/.zshrc (sources $REPO_DIR/shell/.zshrc)"
elif ! grep -qF "source $REPO_DIR/shell/.zshrc" ~/.zshrc; then
    # .zshrc exists but doesn't source our config, prepend loader content
    echo "  ‚Üí Existing ~/.zshrc found, adding source line..."
    tmp_file=$(mktemp)
    sed "s|__REPO_DIR__|$REPO_DIR|g" "$REPO_DIR/shell/.zshrc.loader" > "$tmp_file"
    echo "" >> "$tmp_file"
    echo "# Previous ~/.zshrc content below" >> "$tmp_file"
    cat ~/.zshrc >> "$tmp_file"
    mv "$tmp_file" ~/.zshrc
    echo "  ‚úì Updated ~/.zshrc to source our config (preserved existing content)"
else
    echo "  ‚úì ~/.zshrc already sources our config"
fi

echo ""

# Check if zsh is available
ZSH_PATH=$(get_zsh_path)

if [[ -z "$ZSH_PATH" ]]; then
    echo "‚ö†Ô∏è  zsh not found. Please install zsh manually."
    exit 1
fi

# Prompt user to change shell if not already zsh
if [[ "$SHELL" != "$ZSH_PATH" && "$SHELL" != "/bin/zsh" && "$SHELL" != "/usr/bin/zsh" ]]; then
    echo "üêö Your default shell is not zsh."
    echo ""
    echo "To change your default shell to zsh, run:"
    echo "  chsh -s $ZSH_PATH"
    echo ""
else
    echo "‚úì Default shell is already zsh"
fi

echo ""
echo "‚úì Shell configuration complete!"
echo ""
