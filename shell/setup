#!/bin/bash
set -e

SETUP_DIR="${SETUP_DIR:-$HOME/dev/setup}"

# Source platform detection helpers
source "$SETUP_DIR/lib/platform.sh"

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "Shell Configuration Setup"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

OS=$(detect_os)

# Ensure zsh is installed (especially important for Linux)
ensure_zsh

echo "üìù Copying shell configuration files..."
echo ""

# Copy shell config files
if [[ -f "$SETUP_DIR/shell/.zprofile" ]]; then
    cp "$SETUP_DIR/shell/.zprofile" ~/.zprofile
    echo "  ‚úì Copied .zprofile to home directory"
fi

cp "$SETUP_DIR/shell/.zshrc" ~/.zshrc
echo "  ‚úì Copied .zshrc to home directory"

echo ""

# Change default shell to zsh if not already
ZSH_PATH=$(get_zsh_path)

if [[ -z "$ZSH_PATH" ]]; then
    echo "‚ö†Ô∏è  zsh not found. Please install zsh manually."
    exit 1
fi

if [[ "$SHELL" != "$ZSH_PATH" && "$SHELL" != "/bin/zsh" && "$SHELL" != "/usr/bin/zsh" ]]; then
    # Skip chsh in CI environments where it requires interactive password input
    if [[ -n "$CI" || -n "$GITHUB_ACTIONS" ]]; then
        echo "‚ÑπÔ∏è  Skipping shell change in CI environment"
    else
        echo "üêö Changing default shell to zsh..."
        # Ensure zsh is in /etc/shells on Linux
        if [[ "$OS" == "linux" ]] && ! grep -q "$ZSH_PATH" /etc/shells 2>/dev/null; then
            echo "  ‚Üí Adding $ZSH_PATH to /etc/shells..."
            echo "$ZSH_PATH" | sudo tee -a /etc/shells > /dev/null
        fi
        if chsh -s "$ZSH_PATH" 2>/dev/null; then
            echo "‚úì Default shell changed to zsh"
        else
            echo "‚ö†Ô∏è  Could not change default shell (may require password or sudo)"
            echo "   You can manually change it later with: chsh -s $ZSH_PATH"
        fi
    fi
else
    echo "‚úì Default shell is already zsh"
fi

echo ""
echo "‚úì Shell configuration complete!"
echo ""
