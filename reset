#!/bin/bash
set -e

# Reset script - Nuclear approach to fix broken setups
# This script removes all symlinks/configs, then re-runs setup from scratch
# Use this when something is broken and you want a fresh start

SETUP_DIR="${SETUP_DIR:-$HOME/dev/setup}"

# Source platform detection helpers
source "$SETUP_DIR/lib/platform.sh"

echo "======================================"
echo "Development Environment Reset"
echo "======================================"
echo ""
echo "⚠️  This script will:"
echo "  - Remove all config symlinks and files"
echo "  - Reset git global configuration"
echo "  - Re-run full setup from scratch"
echo ""
read -p "Continue? [y/N] " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
fi

echo ""

print_platform_info
echo ""

# ============================================
# Tear Down - Remove all symlinks and configs
# ============================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Removing existing configurations"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Shell
if [[ -e ~/.zprofile ]]; then
    echo "  → Removing ~/.zprofile..."
    rm -f ~/.zprofile
fi

if [[ -f ~/.zshrc ]]; then
    BACKUP_FILE=~/.zshrc.backup.$(date +%Y%m%d_%H%M%S)
    echo "  → Backing up ~/.zshrc to $BACKUP_FILE..."
    cp ~/.zshrc "$BACKUP_FILE"
    rm -f ~/.zshrc
fi

# Direnv
if [[ -e ~/.config/direnv/direnvrc ]]; then
    echo "  → Removing ~/.config/direnv/direnvrc..."
    rm -f ~/.config/direnv/direnvrc
fi

# Git - remove symlink and reset config values
if [[ -e ~/.gitignore_global ]]; then
    echo "  → Removing ~/.gitignore_global..."
    rm -f ~/.gitignore_global
fi
echo "  → Resetting git global config..."
git config --global --unset core.excludesfile 2>/dev/null || true
git config --global --unset push.autoSetupRemote 2>/dev/null || true
git config --global --unset fetch.prune 2>/dev/null || true
git config --global --unset alias.com 2>/dev/null || true

# Ghostty
if [[ -e ~/.config/ghostty/config ]]; then
    echo "  → Removing ~/.config/ghostty/config..."
    rm -f ~/.config/ghostty/config
fi

# Starship
if [[ -e ~/.config/starship.toml ]]; then
    echo "  → Removing ~/.config/starship.toml..."
    rm -f ~/.config/starship.toml
fi

echo "  ✓ All configurations removed"
echo ""

# ============================================
# Re-run setup
# ============================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Running setup"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

"$SETUP_DIR/setup"
