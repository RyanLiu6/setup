#!/bin/bash
set -e

REPO_DIR="${REPO_DIR:-$(cd "$(dirname "$0")/.." && pwd)}"

# Source platform detection helpers
source "$REPO_DIR/lib/platform.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Direnv Setup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

OS=$(detect_os)

# Install direnv
if ! command -v direnv &> /dev/null; then
    echo "ğŸ“¦ Installing direnv..."
    case "$OS" in
        macos)
            brew install direnv
            ;;
        linux)
            sudo apt-get update -qq
            sudo apt-get install -y direnv
            ;;
    esac
    echo "âœ“ direnv installed successfully"
else
    echo "âœ“ direnv already installed"
fi

echo ""

# Create config directory
echo "ğŸ“ Configuring direnv..."
mkdir -p ~/.config/direnv

# Symlink direnv config
if [ -L ~/.config/direnv/direnvrc ]; then
    echo "âœ“ direnvrc already linked"
elif [ -f ~/.config/direnv/direnvrc ]; then
    echo "  â†’ Backing up existing direnvrc..."
    mv ~/.config/direnv/direnvrc ~/.config/direnv/direnvrc.backup
    ln -s "$REPO_DIR/direnv/direnvrc" ~/.config/direnv/direnvrc
    echo "âœ“ direnvrc linked (backup saved)"
else
    ln -s "$REPO_DIR/direnv/direnvrc" ~/.config/direnv/direnvrc
    echo "âœ“ direnvrc linked to ~/.config/direnv/direnvrc"
fi

echo ""
echo "âœ“ direnv setup complete!"
echo ""
