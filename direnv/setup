#!/bin/bash
set -e

SETUP_DIR="${SETUP_DIR:-$HOME/dev/setup}"

# Source platform detection helpers
source "$SETUP_DIR/lib/platform.sh"

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "Direnv Setup"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

OS=$(detect_os)

# Install direnv
if ! command -v direnv &> /dev/null; then
    echo "üì¶ Installing direnv..."
    case "$OS" in
        macos)
            brew install direnv
            ;;
        linux)
            distro=$(detect_distro)
            case "$distro" in
                debian)
                    sudo apt-get update -qq
                    sudo apt-get install -y direnv
                    ;;
                fedora)
                    sudo dnf install -y direnv
                    ;;
                arch)
                    sudo pacman -S --noconfirm direnv
                    ;;
                *)
                    # Fallback: use official binary installer
                    echo "  ‚Üí Using official installer..."
                    curl -sfL https://direnv.net/install.sh | bash
                    ;;
            esac
            ;;
    esac
    echo "‚úì direnv installed successfully"
else
    echo "‚úì direnv already installed"
fi

echo ""

# Create config directory
echo "üìù Configuring direnv..."
mkdir -p ~/.config/direnv

# Symlink direnv config
if [ -L ~/.config/direnv/direnvrc ]; then
    echo "‚úì direnvrc already linked"
elif [ -f ~/.config/direnv/direnvrc ]; then
    echo "  ‚Üí Backing up existing direnvrc..."
    mv ~/.config/direnv/direnvrc ~/.config/direnv/direnvrc.backup
    ln -s "$SETUP_DIR/direnv/direnvrc" ~/.config/direnv/direnvrc
    echo "‚úì direnvrc linked (backup saved)"
else
    ln -s "$SETUP_DIR/direnv/direnvrc" ~/.config/direnv/direnvrc
    echo "‚úì direnvrc linked to ~/.config/direnv/direnvrc"
fi

echo ""
echo "‚úì direnv setup complete!"
echo ""
