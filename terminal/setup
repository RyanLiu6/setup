#!/bin/bash
set -e

SETUP_DIR="${SETUP_DIR:-$HOME/dev/setup}"

# Source platform detection helpers
source "$SETUP_DIR/lib/platform.sh"

echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "Terminal Environment Setup"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

OS=$(detect_os)

echo "üì¶ Installing terminal tools..."
echo ""

# Install uv via official installer (cross-platform)
if ! command -v uv &> /dev/null; then
    echo "  ‚Üí Installing uv package manager..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    echo "  ‚úì uv installed successfully"
else
    echo "  ‚úì uv already installed"
fi

# Install fnm (Fast Node Manager)
if ! command -v fnm &> /dev/null; then
    echo "  ‚Üí Installing fnm (Node.js version manager)..."
    case "$OS" in
        macos)
            brew install fnm
            ;;
        linux)
            # Use official fnm installer for Linux
            curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell
            ;;
    esac
    echo "  ‚úì fnm installed successfully"
else
    echo "  ‚úì fnm already installed"
fi

# Install pnpm via standalone installer
if ! command -v pnpm &> /dev/null; then
    echo "  ‚Üí Installing pnpm..."
    curl -fsSL https://get.pnpm.io/install.sh | sh -
    echo "  ‚úì pnpm installed successfully"
else
    echo "  ‚úì pnpm already installed"
fi

# Install starship
if ! command -v starship &> /dev/null; then
    echo "  ‚Üí Installing starship (terminal prompt)..."
    case "$OS" in
        macos)
            brew install starship
            ;;
        linux)
            # Use official starship installer for Linux
            curl -sS https://starship.rs/install.sh | sh -s -- -y
            ;;
    esac
    echo "  ‚úì starship installed successfully"
else
    echo "  ‚úì starship already installed"
fi

# Install zsh-completions
install_zsh_completions() {
    case "$OS" in
        macos)
            if ! brew list zsh-completions &> /dev/null; then
                echo "  ‚Üí Installing zsh-completions..."
                brew install zsh-completions
                echo "  ‚úì zsh-completions installed successfully"
            else
                echo "  ‚úì zsh-completions already installed"
            fi
            ;;
        linux)
            local distro=$(detect_distro)
            case "$distro" in
                debian)
                    if ! dpkg -l zsh-completions 2>/dev/null | grep -q "^ii"; then
                        echo "  ‚Üí Installing zsh-completions..."
                        # zsh-completions may not be in all Debian/Ubuntu repos
                        # Try to install, but don't fail if not available
                        if sudo apt-get update -qq && sudo apt-get install -y zsh-completions 2>/dev/null; then
                            echo "  ‚úì zsh-completions installed successfully"
                        else
                            echo "  ‚ÑπÔ∏è  zsh-completions not available in repos (zsh has built-in completions)"
                        fi
                    else
                        echo "  ‚úì zsh-completions already installed"
                    fi
                    ;;
                fedora)
                    if ! rpm -q zsh-completions &> /dev/null; then
                        echo "  ‚Üí Installing zsh-completions..."
                        sudo dnf install -y zsh-completions
                        echo "  ‚úì zsh-completions installed successfully"
                    else
                        echo "  ‚úì zsh-completions already installed"
                    fi
                    ;;
                arch)
                    if ! pacman -Q zsh-completions &> /dev/null; then
                        echo "  ‚Üí Installing zsh-completions..."
                        sudo pacman -S --noconfirm zsh-completions
                        echo "  ‚úì zsh-completions installed successfully"
                    else
                        echo "  ‚úì zsh-completions already installed"
                    fi
                    ;;
                *)
                    echo "  ‚ÑπÔ∏è  Skipping zsh-completions (unsupported distro)"
                    ;;
            esac
            ;;
    esac
}

install_zsh_completions

# Install Ghostty terminal emulator
install_ghostty() {
    case "$OS" in
        macos)
            if ! brew list --cask ghostty &> /dev/null; then
                echo "  ‚Üí Installing Ghostty..."
                brew install --cask ghostty
                echo "  ‚úì Ghostty installed successfully"
            else
                echo "  ‚úì Ghostty already installed"
            fi
            ;;
        linux)
            local distro=$(detect_distro)
            if command -v ghostty &> /dev/null; then
                echo "  ‚úì Ghostty already installed"
            else
                case "$distro" in
                    debian)
                        # Use community Debian repository (https://ghostty.org/docs/install/binary#linux-(official))
                        echo "  ‚Üí Setting up Ghostty Debian repository..."
                        sudo apt-get update -qq
                        sudo apt-get install -y curl gpg
                        curl -fsSL https://debian.griffo.io/signing-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/ghostty-archive-keyring.gpg 2>/dev/null || true
                        echo "deb [signed-by=/usr/share/keyrings/ghostty-archive-keyring.gpg] https://debian.griffo.io/ stable main" | sudo tee /etc/apt/sources.list.d/ghostty.list > /dev/null
                        sudo apt-get update -qq
                        if sudo apt-get install -y ghostty 2>/dev/null; then
                            echo "  ‚úì Ghostty installed successfully"
                        else
                            echo "  ‚ÑπÔ∏è  Ghostty installation failed (may need to build from source)"
                            echo "     See: https://ghostty.org/docs/install/build"
                        fi
                        ;;
                    fedora)
                        echo "  ‚ÑπÔ∏è  Ghostty on Fedora requires manual installation"
                        echo "     See: https://ghostty.org/docs/install/linux"
                        ;;
                    arch)
                        echo "  ‚Üí Installing Ghostty from AUR..."
                        if command -v yay &> /dev/null; then
                            yay -S --noconfirm ghostty
                            echo "  ‚úì Ghostty installed successfully"
                        elif command -v paru &> /dev/null; then
                            paru -S --noconfirm ghostty
                            echo "  ‚úì Ghostty installed successfully"
                        else
                            echo "  ‚ÑπÔ∏è  Install an AUR helper (yay/paru) or build ghostty manually"
                        fi
                        ;;
                    *)
                        echo "  ‚ÑπÔ∏è  Ghostty installation not supported for this distro"
                        echo "     See: https://ghostty.org/docs/install/linux"
                        ;;
                esac
            fi
            ;;
    esac
}

install_ghostty

# Setup Ghostty configuration
setup_ghostty_config() {
    local ghostty_config_dir="$HOME/.config/ghostty"
    local ghostty_config_src="$SETUP_DIR/terminal/ghostty/config"

    if [ -f "$ghostty_config_src" ]; then
        mkdir -p "$ghostty_config_dir"
        if [ -L "$ghostty_config_dir/config" ]; then
            echo "  ‚úì Ghostty config already linked"
        elif [ -f "$ghostty_config_dir/config" ]; then
            echo "  ‚Üí Backing up existing Ghostty config..."
            mv "$ghostty_config_dir/config" "$ghostty_config_dir/config.backup"
            ln -s "$ghostty_config_src" "$ghostty_config_dir/config"
            echo "  ‚úì Ghostty config linked (backup saved)"
        else
            ln -s "$ghostty_config_src" "$ghostty_config_dir/config"
            echo "  ‚úì Ghostty config linked"
        fi
    fi
}

setup_ghostty_config

echo ""
echo "‚úì Terminal environment setup complete!"
echo ""
