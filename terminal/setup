#!/bin/bash
set -e

REPO_DIR="${REPO_DIR:-$(cd "$(dirname "$0")/.." && pwd)}"

# Source platform detection helpers
source "$REPO_DIR/lib/platform.sh"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Terminal Environment Setup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

OS=$(detect_os)

echo "ðŸ“¦ Installing terminal tools..."
echo ""

# Install uv via official installer (cross-platform)
if ! command -v uv &> /dev/null; then
    echo "  â†’ Installing uv package manager..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    echo "  âœ“ uv installed successfully"
else
    echo "  âœ“ uv already installed"
fi

# Install fnm (Fast Node Manager)
if ! command -v fnm &> /dev/null; then
    echo "  â†’ Installing fnm (Node.js version manager)..."
    case "$OS" in
        macos)
            brew install fnm
            ;;
        linux)
            # Use official fnm installer for Linux
            curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell
            ;;
    esac
    echo "  âœ“ fnm installed successfully"
else
    echo "  âœ“ fnm already installed"
fi

# Install pnpm via standalone installer
if ! command -v pnpm &> /dev/null; then
    echo "  â†’ Installing pnpm..."
    curl -fsSL https://get.pnpm.io/install.sh | sh -
    echo "  âœ“ pnpm installed successfully"
else
    echo "  âœ“ pnpm already installed"
fi

# Install starship
if ! command -v starship &> /dev/null; then
    echo "  â†’ Installing starship (terminal prompt)..."
    case "$OS" in
        macos)
            brew install starship
            ;;
        linux)
            # Use official starship installer for Linux
            curl -sS https://starship.rs/install.sh | sh -s -- -y
            ;;
    esac
    echo "  âœ“ starship installed successfully"
else
    echo "  âœ“ starship already installed"
fi

# Install zsh-completions
install_zsh_completions() {
    case "$OS" in
        macos)
            if ! brew list zsh-completions &> /dev/null; then
                echo "  â†’ Installing zsh-completions..."
                brew install zsh-completions
                echo "  âœ“ zsh-completions installed successfully"
            else
                echo "  âœ“ zsh-completions already installed"
            fi
            ;;
        linux)
            if ! dpkg -l zsh-completions 2>/dev/null | grep -q "^ii"; then
                echo "  â†’ Installing zsh-completions..."
                # zsh-completions may not be in all Debian/Ubuntu repos
                # Try to install, but don't fail if not available
                if sudo apt-get update -qq && sudo apt-get install -y zsh-completions 2>/dev/null; then
                    echo "  âœ“ zsh-completions installed successfully"
                else
                    echo "  â„¹ï¸  zsh-completions not available in repos (zsh has built-in completions)"
                fi
            else
                echo "  âœ“ zsh-completions already installed"
            fi
            ;;
    esac
}

install_zsh_completions

# Install Ghostty terminal emulator
install_ghostty() {
    case "$OS" in
        macos)
            if ! brew list --cask ghostty &> /dev/null; then
                echo "  â†’ Installing Ghostty..."
                brew install --cask ghostty
                echo "  âœ“ Ghostty installed successfully"
            else
                echo "  âœ“ Ghostty already installed"
            fi
            ;;
        linux)
            if command -v ghostty &> /dev/null; then
                echo "  âœ“ Ghostty already installed"
            else
                # Detect if Ubuntu or Debian
                if [[ -f /etc/os-release ]]; then
                    . /etc/os-release
                    if [[ "$ID" == "ubuntu" ]] || [[ "$ID_LIKE" == *"ubuntu"* ]]; then
                        # Ubuntu: use community ghostty-ubuntu installer
                        echo "  â†’ Installing Ghostty via ghostty-ubuntu..."
                        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/mkasberg/ghostty-ubuntu/HEAD/install.sh)"
                        echo "  âœ“ Ghostty installed successfully"
                    else
                        # Debian: use debian.griffo.io repository
                        echo "  â†’ Setting up Ghostty Debian repository..."
                        curl -sS https://debian.griffo.io/EA0F721D231FDD3A0A17B9AC7808B4DD62C41256.asc | sudo gpg --dearmor --yes -o /etc/apt/trusted.gpg.d/debian.griffo.io.gpg
                        echo "deb https://debian.griffo.io/apt $(lsb_release -sc 2>/dev/null || echo stable) main" | sudo tee /etc/apt/sources.list.d/debian.griffo.io.list > /dev/null
                        sudo apt-get update -qq
                        sudo apt-get install -y ghostty
                        echo "  âœ“ Ghostty installed successfully"
                    fi
                fi
            fi
            ;;
    esac
}

install_ghostty

# Setup Ghostty configuration
# We symlink the entire ghostty directory so that relative paths in config
# (like config-file = colours/eva01) resolve correctly
setup_ghostty_config() {
    local ghostty_config_dir="$HOME/.config/ghostty"
    local ghostty_src_dir="$REPO_DIR/terminal/ghostty"

    if [ -d "$ghostty_src_dir" ]; then
        # Ensure parent .config directory exists
        mkdir -p "$HOME/.config"

        if [ -L "$ghostty_config_dir" ]; then
            echo "  âœ“ Ghostty config directory already linked"
        elif [ -d "$ghostty_config_dir" ]; then
            echo "  â†’ Backing up existing Ghostty config directory..."
            mv "$ghostty_config_dir" "$ghostty_config_dir.backup"
            ln -s "$ghostty_src_dir" "$ghostty_config_dir"
            echo "  âœ“ Ghostty config directory linked (backup saved)"
        else
            ln -s "$ghostty_src_dir" "$ghostty_config_dir"
            echo "  âœ“ Ghostty config directory linked"
        fi
    fi
}

setup_ghostty_config

# Setup Starship configuration
setup_starship_config() {
    local starship_config="$HOME/.config/starship.toml"
    local starship_src="$REPO_DIR/terminal/starship.toml"

    if [ -f "$starship_src" ]; then
        mkdir -p "$HOME/.config"

        if [ -L "$starship_config" ]; then
            echo "  âœ“ Starship config already linked"
        elif [ -f "$starship_config" ]; then
            echo "  â†’ Backing up existing Starship config..."
            mv "$starship_config" "$starship_config.backup"
            ln -s "$starship_src" "$starship_config"
            echo "  âœ“ Starship config linked (backup saved)"
        else
            ln -s "$starship_src" "$starship_config"
            echo "  âœ“ Starship config linked"
        fi
    fi
}

setup_starship_config

echo ""
echo "âœ“ Terminal environment setup complete!"
echo ""
