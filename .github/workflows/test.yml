name: Test Setup Scripts

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test-setup:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: setup-repo

    - name: Set SETUP_DIR environment variable
      run: echo "SETUP_DIR=$GITHUB_WORKSPACE/setup-repo" >> $GITHUB_ENV

    - name: Install Homebrew (macOS only)
      if: runner.os == 'macOS'
      run: |
        if ! command -v brew &> /dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        # Handle both Intel and Apple Silicon
        if [ -f /opt/homebrew/bin/brew ]; then
          eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [ -f /usr/local/bin/brew ]; then
          eval "$(/usr/local/bin/brew shellenv)"
        fi
        echo "✓ Homebrew is available"

    - name: Run main setup script
      run: |
        cd $SETUP_DIR
        ./setup

    - name: Verify configuration files were created
      run: |
        echo "Checking configuration files..."

        # Check zsh configs
        if [ -f ~/.zshrc ]; then
          echo "✓ ~/.zshrc created"
        else
          echo "✗ ~/.zshrc missing"
          exit 1
        fi

        # Check direnv config
        if [ -f ~/.config/direnv/direnvrc ]; then
          echo "✓ ~/.config/direnv/direnvrc created"
        else
          echo "✗ ~/.config/direnv/direnvrc missing"
          exit 1
        fi

        # Check git config
        if [ -f ~/.gitignore_global ]; then
          echo "✓ ~/.gitignore_global created"
        else
          echo "✗ ~/.gitignore_global missing"
          exit 1
        fi

    - name: Verify installed tools are accessible
      run: |
        echo "Checking installed tools..."

        # Setup PATH based on OS
        if [ "$RUNNER_OS" = "macOS" ]; then
          # Source Homebrew environment
          if [ -f /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [ -f /usr/local/bin/brew ]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
        else
          # Linux: Add fnm to PATH (installed via curl script to ~/.local/share/fnm)
          export PATH="$HOME/.local/share/fnm:$PATH"
          # Add starship to PATH if installed to /usr/local/bin
          export PATH="/usr/local/bin:$PATH"
        fi

        # Add uv and pnpm to PATH (installed via curl scripts)
        export PATH="$HOME/.local/share/pnpm:$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

        # Check uv
        if command -v uv &> /dev/null; then
          echo "✓ uv is available ($(uv --version))"
        else
          echo "✗ uv not found in PATH"
          exit 1
        fi

        # Check fnm
        if command -v fnm &> /dev/null; then
          echo "✓ fnm is available ($(fnm --version))"
        else
          echo "✗ fnm not found"
          exit 1
        fi

        # Check starship
        if command -v starship &> /dev/null; then
          echo "✓ starship is available ($(starship --version))"
        else
          echo "✗ starship not found"
          exit 1
        fi

        # Check direnv
        if command -v direnv &> /dev/null; then
          echo "✓ direnv is available ($(direnv --version))"
        else
          echo "✗ direnv not found"
          exit 1
        fi

        # Check pnpm
        if command -v pnpm &> /dev/null; then
          echo "✓ pnpm is available ($(pnpm --version))"
        else
          echo "✗ pnpm not found"
          exit 1
        fi

    - name: Verify git configuration
      run: |
        echo "Checking git configuration..."

        # Check global gitignore is configured
        GITIGNORE_PATH=$(git config --global core.excludesfile)
        if [ "$GITIGNORE_PATH" = "$HOME/.gitignore_global" ]; then
          echo "✓ Git global gitignore is configured correctly"
        else
          echo "✗ Git global gitignore not configured (got: $GITIGNORE_PATH)"
          exit 1
        fi

        # Check autoSetupRemote
        AUTO_SETUP=$(git config --global push.autoSetupRemote)
        if [ "$AUTO_SETUP" = "true" ]; then
          echo "✓ Git push.autoSetupRemote is enabled"
        else
          echo "✗ Git push.autoSetupRemote not enabled"
          exit 1
        fi

    - name: Verify zsh configuration is valid
      run: |
        echo "Validating zsh configuration..."

        # Ensure zsh is available
        if ! command -v zsh &> /dev/null; then
          echo "⚠ zsh not in PATH, skipping syntax check"
          exit 0
        fi

        # Source zshrc to check for syntax errors
        # We use -n for syntax check without executing
        if zsh -n ~/.zshrc; then
          echo "✓ .zshrc syntax is valid"
        else
          echo "✗ .zshrc has syntax errors"
          exit 1
        fi

    - name: Test direnv layouts
      run: |
        echo "Testing direnv layouts..."

        # Create a test directory
        mkdir -p /tmp/test-direnv-uv
        cd /tmp/test-direnv-uv

        # Create .envrc with layout uv
        echo "layout uv" > .envrc

        # Check if direnv can load it (just check the file is recognized)
        if direnv status | grep -q "Found RC path"; then
          echo "✓ direnv recognizes .envrc files"
        else
          echo "⚠ direnv status check inconclusive (may need direnv allow)"
        fi

    - name: Test setup idempotency
      run: |
        echo "Testing that setup can be run multiple times..."
        cd $SETUP_DIR

        # Run setup again
        ./setup

        echo "✓ Setup script is idempotent (can be run multiple times)"

    - name: Summary
      if: success()
      run: |
        echo ""
        echo "========================================="
        echo "✓ All tests passed on $RUNNER_OS!"
        echo "========================================="
        echo ""
        echo "Verified:"
        echo "  - All setup scripts run without errors"
        echo "  - Configuration files are created"
        echo "  - All tools installed (uv, fnm, pnpm, starship, direnv)"
        echo "  - Git configuration is correct"
        echo "  - ZSH configuration is valid"
        echo "  - Setup is idempotent"
