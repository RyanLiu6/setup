name: Test Setup Scripts

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  test-setup:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: home-repo

    - name: Set REPO_DIR environment variable
      run: echo "REPO_DIR=$GITHUB_WORKSPACE/home-repo" >> $GITHUB_ENV

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install Homebrew (macOS only)
      if: runner.os == 'macOS'
      run: |
        if ! command -v brew &> /dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        # Handle both Intel and Apple Silicon
        if [ -f /opt/homebrew/bin/brew ]; then
          eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [ -f /usr/local/bin/brew ]; then
          eval "$(/usr/local/bin/brew shellenv)"
        fi
        echo "✓ Homebrew is available"

    - name: Validate script syntax
      run: |
        echo "Checking bash script syntax..."
        failed=0
        for f in "$REPO_DIR"/scripts/setup "$REPO_DIR"/scripts/reset $(find "$REPO_DIR" -name 'setup' -path '*/*/setup') "$REPO_DIR"/lib/platform.sh; do
          if [ -f "$f" ]; then
            if bash -n "$f"; then
              echo "✓ $(echo "$f" | sed "s|$REPO_DIR/||") syntax is valid"
            else
              echo "✗ $(echo "$f" | sed "s|$REPO_DIR/||") has syntax errors"
              failed=1
            fi
          fi
        done
        if [ "$failed" -eq 1 ]; then
          exit 1
        fi

    - name: Run main setup script
      run: |
        cd $REPO_DIR
        ./scripts/setup

    - name: Verify configuration files were created
      run: |
        echo "Checking configuration files..."

        # Check zsh configs
        if [ -f ~/.zshrc ]; then
          echo "✓ ~/.zshrc created"
          # Verify it sources our config (path varies based on REPO_DIR)
          if grep -q "source .*/shell/.zshrc" ~/.zshrc; then
            echo "✓ ~/.zshrc sources our config"
          else
            echo "✗ ~/.zshrc does not source our config"
            cat ~/.zshrc
            exit 1
          fi
        else
          echo "✗ ~/.zshrc missing"
          exit 1
        fi

        # Check zprofile (symlink)
        if [ -L ~/.zprofile ]; then
          echo "✓ ~/.zprofile linked"
        else
          echo "✗ ~/.zprofile not linked"
          exit 1
        fi

        # Check direnv config (symlink)
        if [ -L ~/.config/direnv/direnvrc ]; then
          echo "✓ ~/.config/direnv/direnvrc linked"
        else
          echo "✗ ~/.config/direnv/direnvrc not linked"
          exit 1
        fi

        # Check git config (symlink)
        if [ -L ~/.gitignore_global ]; then
          echo "✓ ~/.gitignore_global linked"
        else
          echo "✗ ~/.gitignore_global not linked"
          exit 1
        fi

        # Check git shared config exists
        if [ -f "$REPO_DIR/git/.gitconfig.shared" ]; then
          echo "✓ git/.gitconfig.shared exists"
        else
          echo "✗ git/.gitconfig.shared not found"
          exit 1
        fi

        # Check Ghostty config directory (entire directory is symlinked)
        if [ -L ~/.config/ghostty ]; then
          echo "✓ ~/.config/ghostty directory linked"
        else
          echo "✗ ~/.config/ghostty directory not linked"
          exit 1
        fi

        # Verify colour schemes are accessible (relative paths in config work)
        if [ -f ~/.config/ghostty/colours/eva01 ]; then
          echo "✓ Ghostty colour scheme eva01 accessible"
        else
          echo "✗ Ghostty colour scheme eva01 not accessible"
          exit 1
        fi

        # Check Starship config (symlink)
        if [ -L ~/.config/starship.toml ]; then
          echo "✓ ~/.config/starship.toml linked"
        else
          echo "✗ ~/.config/starship.toml not linked"
          exit 1
        fi

    - name: Verify installed tools are accessible
      run: |
        echo "Checking installed tools..."

        # Setup PATH based on OS
        if [ "$RUNNER_OS" = "macOS" ]; then
          # Source Homebrew environment
          if [ -f /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [ -f /usr/local/bin/brew ]; then
            eval "$(/usr/local/bin/brew shellenv)"
          fi
        else
          # Linux: Add fnm to PATH (installed via curl script to ~/.local/share/fnm)
          export PATH="$HOME/.local/share/fnm:$PATH"
          # Add starship to PATH if installed to /usr/local/bin
          export PATH="/usr/local/bin:$PATH"
        fi

        # Add uv and pnpm to PATH (installed via curl scripts)
        # pnpm: ~/.local/share/pnpm on Linux, ~/Library/pnpm on macOS
        export PNPM_HOME="$HOME/.local/share/pnpm"
        if [ "$RUNNER_OS" = "macOS" ]; then
          export PNPM_HOME="$HOME/Library/pnpm"
        fi
        export PATH="$PNPM_HOME:$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

        # Check uv
        if command -v uv &> /dev/null; then
          echo "✓ uv is available ($(uv --version))"
        else
          echo "✗ uv not found in PATH"
          exit 1
        fi

        # Check fnm
        if command -v fnm &> /dev/null; then
          echo "✓ fnm is available ($(fnm --version))"
        else
          echo "✗ fnm not found"
          exit 1
        fi

        # Check starship
        if command -v starship &> /dev/null; then
          echo "✓ starship is available ($(starship --version))"
        else
          echo "✗ starship not found"
          exit 1
        fi

        # Check direnv
        if command -v direnv &> /dev/null; then
          echo "✓ direnv is available ($(direnv --version))"
        else
          echo "✗ direnv not found"
          exit 1
        fi

        # Check pnpm
        if command -v pnpm &> /dev/null; then
          echo "✓ pnpm is available ($(pnpm --version))"
        else
          echo "✗ pnpm not found"
          exit 1
        fi

        # Check Ghostty
        if [ "$RUNNER_OS" = "macOS" ]; then
          if brew list --cask ghostty &> /dev/null; then
            echo "✓ Ghostty is installed"
          else
            echo "✗ Ghostty not installed"
            exit 1
          fi
        else
          # Linux (Debian/Ubuntu)
          if command -v ghostty &> /dev/null; then
            echo "✓ Ghostty is installed"
          else
            echo "✗ Ghostty not installed"
            exit 1
          fi
        fi

        # Check lazygit
        if command -v lazygit &> /dev/null; then
          echo "✓ lazygit is available ($(lazygit --version | head -1))"
        else
          echo "✗ lazygit not found"
          exit 1
        fi

    - name: Verify git configuration
      run: |
        echo "Checking git configuration..."

        # Check that shared config include path is set
        INCLUDE_PATH=$(git config --global include.path)
        if echo "$INCLUDE_PATH" | grep -q ".gitconfig.shared"; then
          echo "✓ Git include.path is configured for shared config"
        else
          echo "✗ Git include.path not configured (got: $INCLUDE_PATH)"
          exit 1
        fi

        # Check global gitignore is configured (from shared config)
        GITIGNORE_PATH=$(git config --global core.excludesfile)
        if [ "$GITIGNORE_PATH" = "$HOME/.gitignore_global" ]; then
          echo "✓ Git global gitignore is configured correctly"
        else
          echo "✗ Git global gitignore not configured (got: $GITIGNORE_PATH)"
          exit 1
        fi

        # Check autoSetupRemote (from shared config)
        # Note: Use 'git config' without --global to read from included files
        AUTO_SETUP=$(git config push.autosetupremote || echo "")
        if [ "$AUTO_SETUP" = "true" ]; then
          echo "✓ Git push.autoSetupRemote is enabled"
        else
          echo "✗ Git push.autoSetupRemote not enabled (got: '$AUTO_SETUP')"
          exit 1
        fi

        # Check fetch.prune (from shared config)
        FETCH_PRUNE=$(git config fetch.prune || echo "")
        if [ "$FETCH_PRUNE" = "true" ]; then
          echo "✓ Git fetch.prune is enabled"
        else
          echo "✗ Git fetch.prune not enabled"
          exit 1
        fi

        # Check alias.com (from shared config)
        ALIAS_COM=$(git config alias.com || echo "")
        if [ -n "$ALIAS_COM" ]; then
          echo "✓ Git alias.com is configured"
        else
          echo "✗ Git alias.com not configured"
          exit 1
        fi

        # Check alias.prune-branches (from shared config)
        ALIAS_PRUNE=$(git config alias.prune-branches || echo "")
        if [ -n "$ALIAS_PRUNE" ]; then
          echo "✓ Git alias.prune-branches is configured"
        else
          echo "✗ Git alias.prune-branches not configured"
          exit 1
        fi

    - name: Verify zsh configuration is valid
      run: |
        echo "Validating zsh configuration..."

        # Ensure zsh is available
        if ! command -v zsh &> /dev/null; then
          echo "⚠ zsh not in PATH, skipping syntax check"
          exit 0
        fi

        # Check the loader file (~/.zshrc)
        if zsh -n ~/.zshrc; then
          echo "✓ ~/.zshrc loader syntax is valid"
        else
          echo "✗ ~/.zshrc has syntax errors"
          exit 1
        fi

        # Check the main config file (shell/.zshrc)
        if zsh -n "$REPO_DIR/shell/.zshrc"; then
          echo "✓ shell/.zshrc syntax is valid"
        else
          echo "✗ shell/.zshrc has syntax errors"
          exit 1
        fi

        # Check all individual zsh config files
        for f in "$REPO_DIR"/shell/.zsh/*.zsh; do
          if zsh -n "$f"; then
            echo "✓ $(basename "$f") syntax is valid"
          else
            echo "✗ $(basename "$f") has syntax errors"
            exit 1
          fi
        done

    - name: Test direnv layouts
      run: |
        echo "Testing direnv layouts..."

        # Create a test directory
        mkdir -p /tmp/test-direnv-uv
        cd /tmp/test-direnv-uv

        # Create .envrc with layout uv
        echo "layout uv" > .envrc

        # Check if direnv can load it (just check the file is recognized)
        if direnv status | grep -q "Found RC path"; then
          echo "✓ direnv recognizes .envrc files"
        else
          echo "⚠ direnv status check inconclusive (may need direnv allow)"
        fi

    - name: Test setup idempotency
      run: |
        echo "Testing that setup can be run multiple times..."
        cd $REPO_DIR

        # Run setup again
        ./scripts/setup

        echo "✓ Setup script is idempotent (can be run multiple times)"

    - name: Verify AI tool symlinks
      run: |
        echo "Checking AI tool symlinks..."

        # Claude Code
        if [ -L ~/.claude/CLAUDE.md ]; then
          echo "✓ ~/.claude/CLAUDE.md linked"
        else
          echo "✗ ~/.claude/CLAUDE.md not linked"
          exit 1
        fi

        if [ -d ~/.claude/skills ]; then
          echo "✓ ~/.claude/skills directory exists"
        else
          echo "✗ ~/.claude/skills not found"
          exit 1
        fi

        # Gemini CLI
        if [ -L ~/.gemini/GEMINI.md ]; then
          echo "✓ ~/.gemini/GEMINI.md linked"
        else
          echo "✗ ~/.gemini/GEMINI.md not linked"
          exit 1
        fi

        if [ -d ~/.gemini/commands ]; then
          echo "✓ ~/.gemini/commands directory exists"
        else
          echo "✗ ~/.gemini/commands not found"
          exit 1
        fi

        # OpenCode
        if [ -L ~/.config/opencode/AGENTS.md ]; then
          echo "✓ ~/.config/opencode/AGENTS.md linked"
        else
          echo "✗ ~/.config/opencode/AGENTS.md not linked"
          exit 1
        fi

        # Cursor
        if [ -d ~/.cursor/skills ]; then
          echo "✓ ~/.cursor/skills directory exists"
        else
          echo "✗ ~/.cursor/skills not found"
          exit 1
        fi

        # Antigravity
        if [ -d ~/.agent/skills ]; then
          echo "✓ ~/.agent/skills directory exists"
        else
          echo "✗ ~/.agent/skills not found"
          exit 1
        fi

  test-ai:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: home-repo

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        cd $GITHUB_WORKSPACE/home-repo
        uv sync --group dev

    - name: Check formatting
      run: |
        cd $GITHUB_WORKSPACE/home-repo
        uv run ruff format --check

    - name: Lint
      run: |
        cd $GITHUB_WORKSPACE/home-repo
        uv run ruff check

    - name: Type check
      run: |
        cd $GITHUB_WORKSPACE/home-repo
        uv run mypy scripts/ tasks.py tests/

    - name: Run tests
      run: |
        cd $GITHUB_WORKSPACE/home-repo
        uv run pytest -v

  test-reset:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: home-repo

    - name: Set REPO_DIR environment variable
      run: echo "REPO_DIR=$GITHUB_WORKSPACE/home-repo" >> $GITHUB_ENV

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install Homebrew (macOS only)
      if: runner.os == 'macOS'
      run: |
        if ! command -v brew &> /dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        # Handle both Intel and Apple Silicon
        if [ -f /opt/homebrew/bin/brew ]; then
          eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [ -f /usr/local/bin/brew ]; then
          eval "$(/usr/local/bin/brew shellenv)"
        fi
        echo "✓ Homebrew is available"

    - name: Run initial setup
      run: |
        cd $REPO_DIR
        ./scripts/setup

    - name: Run reset script
      run: |
        echo "Testing reset script..."
        cd $REPO_DIR

        # Run reset (auto-confirm with yes)
        echo "y" | ./scripts/reset

    - name: Verify symlinks were recreated
      run: |
        echo "Verifying symlinks were recreated..."

        if [ -L ~/.zprofile ]; then
          echo "✓ .zprofile symlink recreated"
        else
          echo "✗ .zprofile symlink not recreated"
          exit 1
        fi

        if [ -L ~/.config/direnv/direnvrc ]; then
          echo "✓ direnvrc symlink recreated"
        else
          echo "✗ direnvrc symlink not recreated"
          exit 1
        fi

        if [ -L ~/.gitignore_global ]; then
          echo "✓ .gitignore_global symlink recreated"
        else
          echo "✗ .gitignore_global symlink not recreated"
          exit 1
        fi

        if [ -L ~/.config/ghostty ]; then
          echo "✓ ghostty directory symlink recreated"
        else
          echo "✗ ghostty directory symlink not recreated"
          exit 1
        fi

        # Verify colour schemes are accessible after reset
        if [ -f ~/.config/ghostty/colours/eva01 ]; then
          echo "✓ ghostty colour scheme accessible after reset"
        else
          echo "✗ ghostty colour scheme not accessible after reset"
          exit 1
        fi

        if [ -L ~/.config/starship.toml ]; then
          echo "✓ starship.toml symlink recreated"
        else
          echo "✗ starship.toml symlink not recreated"
          exit 1
        fi

    - name: Verify git config was re-applied
      run: |
        echo "Verifying git configuration..."

        # Check that shared config include path is set
        INCLUDE_PATH=$(git config --global include.path)
        if echo "$INCLUDE_PATH" | grep -q ".gitconfig.shared"; then
          echo "✓ Git include.path re-configured for shared config"
        else
          echo "✗ Git include.path not re-configured (got: $INCLUDE_PATH)"
          exit 1
        fi

        if [ "$(git config --global core.excludesfile)" = "$HOME/.gitignore_global" ]; then
          echo "✓ Git core.excludesfile re-configured"
        else
          echo "✗ Git core.excludesfile not re-configured"
          exit 1
        fi

        if [ "$(git config push.autosetupremote)" = "true" ]; then
          echo "✓ Git push.autoSetupRemote re-configured"
        else
          echo "✗ Git push.autoSetupRemote not re-configured"
          exit 1
        fi

        if [ "$(git config fetch.prune)" = "true" ]; then
          echo "✓ Git fetch.prune re-configured"
        else
          echo "✗ Git fetch.prune not re-configured"
          exit 1
        fi

        if [ -n "$(git config alias.com)" ]; then
          echo "✓ Git alias.com re-configured"
        else
          echo "✗ Git alias.com not re-configured"
          exit 1
        fi

        if [ -n "$(git config alias.prune-branches)" ]; then
          echo "✓ Git alias.prune-branches re-configured"
        else
          echo "✗ Git alias.prune-branches not re-configured"
          exit 1
        fi

        echo "✓ Reset script works correctly"

    - name: Test reset --keep preserves tool content
      run: |
        echo "Testing --keep flag preserves tool-installed content..."

        # Inject known content after the marker in ~/.zshrc
        echo "" >> ~/.zshrc
        echo "# Added by test-ci" >> ~/.zshrc
        echo 'export TEST_KEEP_FLAG="preserved"' >> ~/.zshrc

        # Verify the content was injected
        if grep -q "TEST_KEEP_FLAG" ~/.zshrc; then
          echo "✓ Test content injected into ~/.zshrc"
        else
          echo "✗ Failed to inject test content"
          exit 1
        fi

        # Run reset with --keep
        cd $REPO_DIR
        uv run --directory "$REPO_DIR" inv reset --yes --keep

        # Verify the injected content persists
        if grep -q "TEST_KEEP_FLAG" ~/.zshrc; then
          echo "✓ Tool content preserved after reset --keep"
        else
          echo "✗ Tool content lost after reset --keep"
          cat ~/.zshrc
          exit 1
        fi

        # Verify all symlinks still valid
        if [ -L ~/.zprofile ]; then
          echo "✓ .zprofile symlink valid after --keep reset"
        else
          echo "✗ .zprofile symlink missing after --keep reset"
          exit 1
        fi

        if [ -L ~/.config/direnv/direnvrc ]; then
          echo "✓ direnvrc symlink valid after --keep reset"
        else
          echo "✗ direnvrc symlink missing after --keep reset"
          exit 1
        fi

        if [ -L ~/.gitignore_global ]; then
          echo "✓ .gitignore_global symlink valid after --keep reset"
        else
          echo "✗ .gitignore_global symlink missing after --keep reset"
          exit 1
        fi

        echo "✓ Reset --keep works correctly"
